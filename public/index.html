<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Cloud Browser</title>
  <style>
    :root{
      --bg:#0f172a; --bg2:#0b1226; --chip:#172033; --chip-on:#123a2a;
      --fg:#e5e7eb; --muted:#aeb4c0; --accent:#3b82f6; --warn:#f59e0b; --err:#ef4444; --ok:#22c55e;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--fg); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      height:100dvh; display:flex; flex-direction:column; gap:10px; padding:10px;
    }
    .bar{
      display:grid; grid-template-columns:auto auto 1fr auto auto; gap:10px; align-items:center;
    }
    .btn{
      width:44px;height:44px; border-radius:14px; background:#111a2e; border:1px solid #1c2741;
      display:grid; place-items:center; cursor:pointer; transition:transform .06s ease, background .15s;
    }
    .btn:hover{ background:#15203a }
    .btn:active{ transform:scale(.98) }
    .btn svg{ width:22px;height:22px; stroke:var(--fg)}
    .url{
      height:44px; border-radius:14px; background:#0f1a30; border:1px solid #1c2741; color:var(--fg);
      padding:0 14px; width:100%; outline:none; font-size:16px;
    }
    .chips{display:flex; gap:10px}
    .chip{
      height:44px; display:flex; align-items:center; gap:10px;
      background:#101a2f; border:1px solid #1c2741; padding:0 14px; border-radius:14px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.err{ background:var(--err) } .dot.warn{ background:var(--warn) } .dot.ok{ background:var(--ok) }
    iframe{
      width:100%; flex:1 1 auto; border:none; border-radius:16px; background:#000;
    }
    .hidden{ display:none !important }
  </style>

  <!-- Ultraviolet runtime (same-origin) -->
  <script src="/uv.bundle.js"></script>
  <script src="/uv.config.js"></script>

  <!-- Bare-Mux (same-origin, ESM) -->
  <script type="module">
    import { BareMux } from '/bare-mux.bundle.mjs';

    // --- endpoints you control ---
    const BARE_ORIGIN = 'https://bare-transport.jcullenr1236496.workers.dev';
    const WISP_WS     = 'wss://voiceless-dorry-nothinggames-cd908596.koyeb.app';

    // --- UI refs
    const $ = sel => document.querySelector(sel);
    const urlBar = $('#url');
    const frame  = $('#view');
    const chipTransport = $('#chip-transport');
    const chipWs  = $('#chip-ws');
    const chipHttp= $('#chip-http');

    // Pretty statuses
    const setChip = (chip, status, text) => {
      const dot = chip.querySelector('.dot');
      dot.className = 'dot ' + (status === 'ok' ? 'ok' : status === 'warn' ? 'warn' : 'err');
      chip.lastChild.textContent = ' ' + text;
    };

    // --- SharedWorker (must be same-origin)
    const mux = new BareMux({
      worker: '/bare-mux-worker.js',
      // Route prefix for /v1 requests the client emits
      // We point to your Cloudflare Worker using full URL:
      // (Bare-Mux only needs the absolute origin for HTTP)
      http: { origin: BARE_ORIGIN },
      ws:   { url: WISP_WS }
    });

    // Update status while connecting
    setChip(chipTransport, 'warn', 'transport: connecting…');
    setChip(chipWs, 'warn', 'WS');
    setChip(chipHttp, 'warn', 'HTTP');

    // Smoke tests
    const wsProbe = new Promise(res => {
      try {
        const s = new WebSocket(WISP_WS);
        s.onopen = () => { s.close(); res(true); };
        s.onerror = () => res(false);
      } catch { res(false); }
    });
    const httpProbe = fetch(BARE_ORIGIN + '/v1/', { method:'HEAD', mode:'no-cors' })
      .then(() => true).catch(() => false);

    Promise.all([wsProbe, httpProbe]).then(([wsOk, httpOk]) => {
      setChip(chipWs,   wsOk   ? 'ok' : 'err', 'WS');
      setChip(chipHttp, httpOk ? 'ok' : 'err', 'HTTP');
      const overall = (wsOk && httpOk) ? ['ok','ready'] : ['warn','degraded'];
      setChip(chipTransport, overall[0], `transport: ${overall[1]}`);
    });

    // --- Ultraviolet service worker (needed for full HTTP proxying)
    async function readyUv() {
      if (!('serviceWorker' in navigator)) throw new Error('SW unsupported');
      // Important: scope must include where we’ll navigate ("/")
      await navigator.serviceWorker.register('/uv.sw.js', { scope: '/' });
      await navigator.serviceWorker.ready;
    }

    // Helpers: url or search
    const looksLikeUrl = (v) => {
      const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(v);
      const hasDot = /\./.test(v);
      return hasScheme || hasDot;
    };
    const toUrl = (v) => {
      v = v.trim();
      if (!v) return '';
      if (!looksLikeUrl(v)) {
        // Google search when not a URL
        return `https://www.google.com/search?q=${encodeURIComponent(v)}`;
      }
      if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(v)) {
        // no scheme → default to https
        return 'https://' + v;
      }
      return v;
    };

    async function navigate(raw) {
      const target = toUrl(raw);
      if (!target) return;
      // UV uses a path prefix; __uv$config is exposed by uv.config.js
      // The SW will rewrite everything under this prefix.
      const encoded = __uv$config.encodeUrl(target);
      frame.src = __uv$config.prefix + encoded;
    }

    // UI wiring
    urlBar.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        navigate(urlBar.value);
      }
    });
    $('#btn-back').onclick = () => frame.contentWindow?.history?.back?.();
    $('#btn-fwd').onclick  = () => frame.contentWindow?.history?.forward?.();
    $('#btn-reload').onclick = () => {
      // If we’re on UV, reload the iframe; otherwise re-navigate
      try { frame.contentWindow?.location?.reload(); } catch { navigate(urlBar.value); }
    };

    // Allow programmatic fullscreen if site asks (and a manual button if you want later)
    document.addEventListener('fullscreenerror', () => {
      console.warn('Fullscreen request failed');
    });

    // Init
    readyUv().catch(err => {
      setChip(chipTransport, 'err', 'transport: SW failed');
      console.error(err);
    });

    // Default start page: blank URL bar but shows Google on Enter even w/out scheme
    urlBar.placeholder = 'Type a URL or search Google';
  </script>
</head>

<body>
  <div class="bar">
    <button id="btn-back" class="btn" title="Back" aria-label="Back">
      <svg viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button id="btn-fwd" class="btn" title="Forward" aria-label="Forward">
      <svg viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button id="btn-reload" class="btn" title="Reload" aria-label="Reload">
      <!-- circular refresh icon -->
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M20 12a8 8 0 10-3 6.2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 7v5h-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <input id="url" class="url" autocomplete="off" spellcheck="false" />

    <div class="chips">
      <div id="chip-transport" class="chip"><span class="dot warn"></span> transport: connecting…</div>
      <div id="chip-ws" class="chip"><span class="dot warn"></span> WS</div>
      <div id="chip-http" class="chip"><span class="dot warn"></span> HTTP</div>
    </div>
  </div>

  <!-- IMPORTANT: allow fullscreen + features; sandbox is kept permissive -->
  <iframe id="view"
          allow="fullscreen; autoplay; clipboard-read; clipboard-write; microphone; camera; geolocation; display-capture; screen-wake-lock; web-share;"
          allowfullscreen
          sandbox="allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation">
  </iframe>
</body>
</html>
