<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cloud Browser</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{--bg:#0f1220;--panel:#171a2a;--accent:#6aa5ff;--text:#e9edff;--muted:#9aa3b2;--ok:#27c07d;--danger:#ff6a6a;--border:#2a2f45;--radius:16px;--shadow:0 10px 30px rgba(0,0,0,.25)}
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .shell{display:grid;grid-template-rows:auto 1fr;gap:10px;height:100%;padding:14px}
    .topbar{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px}
    .btn{border:1px solid var(--border);background:#121528;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .omnibox{display:flex;align-items:center;gap:8px;background:#0e1122;border:1px solid var(--border);border-radius:12px;padding:6px 10px}
    .omnibox input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:14px}
    .badge{font-size:11px;color:var(--muted);border:1px dashed var(--border);padding:2px 6px;border-radius:8px}
    .status{font-size:12px;color:var(--muted);display:inline-flex;gap:10px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--danger);display:inline-block}
    .dot.ok{background:var(--ok)}
    .viewport{position:relative;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);background:#0b0e1c}
    iframe{width:100%;height:100%;border:0;background:#0b0e1c}
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div style="display:flex;gap:6px">
        <button class="btn" id="backBtn" type="button" title="Back">‚üµ</button>
        <button class="btn" id="fwdBtn" type="button" title="Forward">‚ü∂</button>
        <button class="btn" id="refreshBtn" type="button" title="Refresh">‚Üª</button>
      </div>

      <form class="omnibox" id="omniform" autocomplete="off">
        <span style="opacity:.85">üåê</span>
        <input id="omnibox" placeholder="Search or enter address" spellcheck="false" />
        <span class="badge" id="transportBadge">transport: connecting‚Ä¶</span>
      </form>

      <div class="status">
        <span class="dot" id="wsDot"></span><span>WS</span>
        <span class="dot" id="httpDot"></span><span>HTTP</span>
      </div>

      <button class="btn" id="newTabBtn" type="button" title="New tab">Ôºã</button>
    </div>

    <div class="viewport">
      <iframe id="view"
              sandbox="allow-scripts allow-same-origin allow-forms allow-downloads allow-popups"
              referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

  <script type="module">
    const WISP_ENDPOINTS = [
      "wss://voiceless-dorry-nothinggames-cd908596.koyeb.app"
    ];
    const HOMEPAGE = "https://www.google.com/";

    import { BareMuxConnection, BareClient } from "https://esm.sh/@mercuryworkshop/bare-mux@2.1.7?bundle";
    const EPOXY_MOD_URL = "https://cdn.jsdelivr.net/npm/@mercuryworkshop/epoxy-transport@2.1.28/lib/index.mjs";

    const badge   = document.getElementById("transportBadge");
    const wsDot   = document.getElementById("wsDot");
    const httpDot = document.getElementById("httpDot");
    const view    = document.getElementById("view");
    const form    = document.getElementById("omniform");
    const box     = document.getElementById("omnibox");
    const backBtn = document.getElementById("backBtn");
    const fwdBtn  = document.getElementById("fwdBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const setDot = (el, ok) => el.classList.toggle("ok", !!ok);
    const setBadge = (txt) => badge.textContent = "transport: " + txt;

    function toUrlOrSearch(input) {
      const s = (input || "").trim();
      if (!s) return HOMEPAGE;
      const scheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(s);
      const looksHost = /^[^\s/]+\.[^\s/]+/.test(s);
      if (scheme) return s;
      if (looksHost) return "https://" + s;
      return "https://www.google.com/search?q=" + encodeURIComponent(s);
    }

    let bare = null;
    let transportReady = false;

    async function initTransports() {
      setBadge("connecting‚Ä¶");
      try {
// ‚úÖ use the same-origin shim you added at public/bare-mux-worker.js
const mux = new BareMuxConnection("/bare-mux-worker.js");


        let ok = false, lastErr = null;
        for (const w of WISP_ENDPOINTS) {
          try {
            await mux.setTransport(EPOXY_MOD_URL, [{ wisp: w }]);
            ok = true; break;
          } catch (e) { lastErr = e; }
        }
        if (!ok) throw lastErr || new Error("no wisp transport available");

        bare = new BareClient();
        transportReady = true;
        setBadge("epoxy+wisp");
        setDot(wsDot, true);
        setDot(httpDot, true);
      } catch (err) {
        console.error("transport init failed", err);
        setBadge("error");
        setDot(wsDot, false);
        setDot(httpDot, false);
        transportReady = false;
      }
    }

    await initTransports();

    async function navigate(raw) {
      const target = toUrlOrSearch(raw);
      if (!transportReady || !bare) { alert("Transport not ready."); return; }
      try {
        const res = await bare.fetch(target, { method: "GET" });
        const ct = (res.headers.get("content-type") || "").toLowerCase();
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        view.src = url;
        view.addEventListener("load", () => setTimeout(() => URL.revokeObjectURL(url), 500), { once:true });
      } catch (e) {
        console.error("navigate error", e);
        const errHtml = `<!doctype html><meta charset="utf-8"><body style="background:#0b0e14;color:#e8f0fe;font-family:system-ui"><div style="max-width:860px;margin:8vh auto;padding:24px"><h2>Load error</h2><pre style="background:#111319;border:1px solid #1b1f2a;border-radius:10px;padding:12px;white-space:pre-wrap">${(e&&e.stack)||e}</pre></div></body>`;
        const blob = new Blob([errHtml], { type: "text/html" });
        view.src = URL.createObjectURL(blob);
      }
    }

    form.addEventListener("submit", (e)=>{ e.preventDefault(); navigate(box.value); });
    refreshBtn.addEventListener("click", ()=>view.contentWindow?.location?.reload());
    backBtn.addEventListener("click", ()=>view.contentWindow?.history?.back());
    fwdBtn.addEventListener("click", ()=>view.contentWindow?.history?.forward());

    navigate(HOMEPAGE);
    // optional WS smoke:
    try { if (transportReady && bare) { const ws = bare.createWebSocket("wss://echo.websocket.events"); ws.onopen=()=>ws.send("hi"); ws.onmessage=(e)=>{console.log("echo",e.data); ws.close();}; } } catch {}
  </script>
</body>
</html>