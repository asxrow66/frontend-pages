<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud Browser</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{
      --bg:#0e1220; --chrome:#14182b; --chrome-2:#0f1324;
      --text:#e7e9f4; --muted:#98a2b3; --btn:#1f2b4d; --btnh:#26345d;
      --ring:#4f46e5; --ok:#22c55e; --bad:#ef4444; --amb:#f59e0b;
      --radius:14px; --sh:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial}
    .chrome{position:sticky;top:0;z-index:5;padding:10px 12px;background:linear-gradient(180deg,var(--chrome),var(--chrome-2) 140%);box-shadow:var(--sh)}
    .row{display:flex;align-items:center;gap:10px}
    .brand{font-weight:700;opacity:.85;margin-right:8px}
    .btn{height:38px;width:44px;border-radius:10px;display:grid;place-items:center;background:var(--btn);border:1px solid #ffffff10;color:var(--text);cursor:pointer;transition:.15s}
    .btn:hover{background:var(--btnh)}
    .i{width:16px;height:16px;display:inline-block}
    .i.b{border-left:2px solid currentColor;border-bottom:2px solid currentColor;transform:rotate(45deg)}
    .i.f{border-right:2px solid currentColor;border-top:2px solid currentColor;transform:rotate(45deg)}
    .i.r{border:2px solid currentColor;border-radius:50%}
    .i.plus{position:relative} .i.plus::before,.i.plus::after{content:"";position:absolute;inset:7px 3px;background:currentColor}
    .i.plus::after{transform:rotate(90deg)}
    .addr{flex:1;height:40px;padding:0 14px;background:var(--chrome-2);border:1px solid #ffffff14;border-radius:12px;outline:0;color:var(--text);font-size:15px}
    .addr:focus{border-color:#4f46e580;box-shadow:inset 0 0 0 2px var(--ring)}
    .addr::placeholder{color:#6b7280}
    .pill{height:28px;padding:0 10px;border-radius:999px;display:inline-flex;align-items:center;gap:6px;background:#ffffff10;border:1px solid #ffffff14;color:#aab1c3;font-size:12px}
    .dot{width:8px;height:8px;border-radius:999px;background:#f59e0b}
    .ok .dot{background:var(--ok)} .bad .dot{background:var(--bad)}
    .wrap{position:fixed;inset:70px 12px 12px 12px;background:#0a0d1a;border:1px solid #ffffff0f;border-radius:var(--radius);overflow:hidden;box-shadow:var(--sh)}
    iframe{width:100%;height:100%;border:0;background:#0a0d1a}
  </style>

  <!-- Ultraviolet runtime (local files you’ll add in step 2) -->
  <script defer src="/uv/uv.bundle.js"></script>
  <script defer src="/uv/uv.config.js"></script>
</head>
<body>
  <div class="chrome">
    <form id="nav" class="row" autocomplete="off">
      <span class="brand">Cloud Browser</span>
      <button type="button" id="back"   class="btn" title="Back"><span class="i b"></span></button>
      <button type="button" id="fwd"    class="btn" title="Forward"><span class="i f"></span></button>
      <button type="button" id="reload" class="btn" title="Reload"><span class="i r"></span></button>
      <input id="url" class="addr" placeholder="Type a URL or search Google…" />
      <span id="pill-transport" class="pill"><span class="dot"></span><span id="t-label">transport: connecting…</span></span>
      <span id="pill-ws"  class="pill"><span class="dot"></span>WS</span>
      <span id="pill-http" class="pill"><span class="dot"></span>HTTP</span>
      <button type="button" class="btn" title="New tab"><span class="i plus"></span></button>
    </form>
  </div>

  <div class="wrap">
    <!-- Everything under __uv$config.prefix is fully proxied by the SW -->
    <iframe id="view"></iframe>
  </div>

  <script>
    const $ = (s, r=document)=>r.querySelector(s);
    const urlBox = $("#url"), frame=$("#view");
    const pillTransport=$("#pill-transport"), pillWS=$("#pill-ws"), pillHTTP=$("#pill-http"), tLabel=$("#t-label");

    const isProbablyUrl = (s)=>{
      try{
        if (/^[a-zA-Z][a-zA-Z0-9+\-.]*:/.test(s)) { new URL(s); return true; }
        if (s.includes(" ") || !s.includes(".")) return false;
        new URL("https://"+s); return true;
      }catch{return false;}
    };
    const abs = (s)=>/^[a-zA-Z][a-zA-Z0-9+\-.]*:/.test(s)?s:"https://"+s;

    async function registerSW(){
      if (!("serviceWorker" in navigator)) return;
      await navigator.serviceWorker.register("/sw.js", { scope: self.__uv$config.prefix });
    }

    // Status dots
    const ok = (el, label)=>{ el.classList.add("ok"); el.classList.remove("bad"); if(el===pillTransport&&label) tLabel.textContent="transport: "+label; }
    const bad= (el, label)=>{ el.classList.add("bad"); el.classList.remove("ok"); if(el===pillTransport&&label) tLabel.textContent="transport: "+label; }

    async function health(){
      try {
        // SharedWorker (Bare-Mux) should load because we serve it from same origin
        const w = new SharedWorker("/bare-mux-worker.js",{type:"classic",name:"bare-mux"}); w.port.start(); ok(pillTransport,"SharedWorker");
      } catch(e){ bad(pillTransport,"worker blocked"); console.error(e); }
      try {
        await new Promise((res,rej)=>{ const ws=new WebSocket(self.__uv$config.wisp); ws.onopen=()=>{ws.close();res()}; ws.onerror=rej; });
        ok(pillWS);
      } catch(e){ bad(pillWS); console.error(e); }
      try {
        const r = await fetch(self.__uv$config.bare, { method:"OPTIONS" });
        if (r.ok) ok(pillHTTP); else throw new Error(r.status);
      } catch(e){ bad(pillHTTP); console.error(e); }
    }

    function uvUrl(target){
      // Do NOT force "https://" in the visible bar
      return self.__uv$config.prefix + Ultraviolet.codec.xor.encode(target);
    }

    async function navigate(input){
      const t = input.trim(); if(!t) return;
      urlBox.value = t; // keep exactly what user typed
      const dest = isProbablyUrl(t) ? abs(t) : ("https://www.google.com/search?q=" + encodeURIComponent(t));
      frame.src = uvUrl(dest);  // FULL PROXY via SW
    }

    $("#nav").addEventListener("submit", (e)=>{ e.preventDefault(); navigate(urlBox.value); });
    $("#reload").addEventListener("click", ()=> frame.contentWindow?.location.reload());
    $("#back").addEventListener("click", ()=> frame.contentWindow?.history.back());
    $("#fwd").addEventListener("click", ()=> frame.contentWindow?.history.forward());

    (async ()=>{
      await registerSW();
      await health();
      urlBox.value="google.com";        // search-first UX
      navigate("google.com");
    })();
  </script>
</body>
</html>
