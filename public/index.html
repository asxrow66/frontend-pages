<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title></title>

  <!-- Ultraviolet core (already in your repo) -->
  <script src="/uv.bundle.js" defer></script>
  <script src="/uv.config.js" defer></script>

  <!-- Status chips + nav styles -->
  <style>
    :root {
      --bg: #0f1320;
      --bg-soft: #151a2c;
      --chip: #1b2139;
      --text: #d6d9e6;
      --muted: #9aa3b2;
      --accent: #6ea8fe;
      --ok: #27c281;
      --warn: #f0a500;
      --bad: #ff6b6b;
      --ring: #2a3357;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; }
    .bar {
      display: grid;
      grid-template-columns: auto auto 1fr auto auto auto;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0)) , var(--bg);
      border-bottom: 1px solid var(--ring);
    }
    .btn {
      height: 44px; width: 64px;
      display: grid; place-items: center;
      background: var(--bg-soft);
      border: 1px solid var(--ring);
      border-radius: 14px;
      cursor: pointer;
      transition: 120ms ease;
    }
    .btn:active { transform: translateY(1px); }
    .btn svg { width: 22px; height: 22px; stroke: var(--text); }
    .addr-wrap {
      height: 44px; display: grid; align-items: center;
      background: var(--bg-soft);
      border: 1px solid var(--ring); border-radius: 14px; padding: 0 14px;
    }
    #address {
      width: 100%; height: 40px; outline: none; border: 0;
      background: transparent; color: var(--text);
      font-size: 16px;
    }
    .chip {
      display: inline-grid; grid-auto-flow: column; align-items: center; gap: 8px;
      height: 44px; padding: 0 14px;
      background: var(--chip);
      border: 1px solid var(--ring); border-radius: 14px; color: var(--text);
      font-size: 14px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--warn); }
    .dot.ok { background: var(--ok); }
    .dot.bad { background: var(--bad); }

    .stage { height: calc(100% - 66px); }
    #view {
      width: 100%; height: 100%; border: 0; display: block;
      background: #000;
    }
  </style>
</head>
<body>
  <div class="bar">
    <!-- (Removed “Cloud Browser” label and “+” new-tab button) -->
    <button class="btn" id="back" title="Back">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button class="btn" id="forward" title="Forward">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <button class="btn" id="reload" title="Reload">
      <!-- circular arrow icon -->
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
        <path d="M3 12a9 9 0 1 0 3-6.708" stroke="currentColor" stroke-linecap="round"/>
        <path d="M3 4v4h4" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>

    <form class="addr-wrap" id="nav">
      <input id="address" placeholder="Type a URL or search Google" autocomplete="off" spellcheck="false" />
    </form>

    <div class="chip"><span class="dot" id="chip-transport"></span><span id="chip-transport-text">transport: connecting…</span></div>
    <div class="chip"><span class="dot" id="chip-ws"></span>WS</div>
    <div class="chip"><span class="dot" id="chip-http"></span>HTTP</div>
  </div>

  <main class="stage">
    <!-- Allow fullscreen & lots of capabilities for things like GeForce NOW -->
    <iframe id="view"
      sandbox="allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-downloads"
      allow="fullscreen *; autoplay *; gamepad *; clipboard-read *; clipboard-write *; xr-spatial-tracking *; geolocation *; microphone *; camera *; display-capture *; midi *; encrypted-media *"
      allowfullscreen
    ></iframe>
  </main>

  <script type="module">
    // -------------------------
    // EDIT THESE 3 ENDPOINTS
    // -------------------------
    const PAGES_ORIGIN = location.origin; // your Pages site (this page)
    const BARE_HTTP    = "https://bare-transport.jcullenr1236496.workers.dev"; // Cloudflare Worker Bare HTTP
    const WISP_WS      = "wss://voiceless-dorry-nothinggames-cd908596.koyeb.app"; // Koyeb Wisp for WS

    // IMPORTANT: your Koyeb env must be EXACT origin without trailing slash:
    //   ALLOW_ORIGIN = https://frontend-pages-dfl.pages.dev

    // 1) Register UV service worker (drives HTTP proxying)
    async function installSW() {
      if (!("serviceWorker" in navigator)) return false;
      try {
        await navigator.serviceWorker.register("/uv.sw.js", { scope: "/" });
        await navigator.serviceWorker.ready;
        return true;
      } catch {
        return false;
      }
    }

    // 2) Tell UV where the Bare server lives (HTTP) and the mux worker path (WS)
    //    We keep the input as typed; no forced "https://" in the UI.
    //    UV will encode it under the hood.
    function configureUV() {
      // bare endpoint (HTTP). UV expects a base URL that it will append /v1 automatically.
      // Keep a trailing slash.
      if (window.__uv$config) {
        __uv$config.bare = BARE_HTTP.endsWith("/") ? BARE_HTTP : BARE_HTTP + "/";
      }

      // Where Bare-Mux worker is hosted (must be SAME ORIGIN!)
      // We self-host at /bare-mux-worker.js (added below).
      window.__BARE_MUX_WORKER_URL = "/bare-mux-worker.js";

      // Where WebSockets should tunnel to (Wisp server)
      window.__WISP_ENDPOINT = WISP_WS;
    }

    // 3) Minimal navigation helpers
    const addr = document.getElementById("address");
    const view = document.getElementById("view");

    function toTarget(input) {
      const s = input.trim();
      // If it looks like a URL with a dot or has a scheme, build URL. Else use Google search.
      const looksLikeURL = /^[a-z]+:\/\//i.test(s) || (s.includes(".") && !s.includes(" "));
      const target = looksLikeURL ? ( /^[a-z]+:\/\//i.test(s) ? s : `https://${s}` )
                                  : `https://www.google.com/search?q=${encodeURIComponent(s)}`;
      return target;
    }

    function uvEncode(url) {
      // Provided by uv.bundle.js
      return __uv$config.prefix + __uv$config.encodeUrl(url);
    }

    document.getElementById("nav").addEventListener("submit", (e) => {
      e.preventDefault();
      const target = toTarget(addr.value);
      view.src = uvEncode(target);
    });

    // Back/forward/reload
    document.getElementById("back").onclick = () => view.contentWindow?.history.back();
    document.getElementById("forward").onclick = () => view.contentWindow?.history.forward();
    document.getElementById("reload").onclick = () => {
      // Try to reload the frame if it already navigated, otherwise reload this page.
      if (view.src) view.contentWindow?.location.reload();
      else location.reload();
    };

    // 4) Status chips
    const chipTransport = document.getElementById("chip-transport");
    const chipTransportText = document.getElementById("chip-transport-text");
    const chipHTTP = document.getElementById("chip-http");
    const chipWS = document.getElementById("chip-ws");

    const setDot = (el, state) => {
      el.classList.remove("ok", "bad");
      if (state === "ok") el.classList.add("ok");
      else if (state === "bad") el.classList.add("bad");
    };

    async function probeHTTP() {
      // We don't send Bare headers here on purpose; we only care that the origin is reachable.
      try {
        const r = await fetch(BARE_HTTP + (BARE_HTTP.endsWith("/") ? "" : "/"), { mode: "cors" });
        setDot(chipHTTP, r.status >= 200 && r.status < 500 ? "ok" : "bad");
      } catch {
        setDot(chipHTTP, "bad");
      }
    }

    async function probeWS() {
      return new Promise((resolve) => {
        try {
          const ws = new WebSocket(WISP_WS);
          let done = false;
          const finish = (ok) => { if (done) return; done = true; try { ws.close(); } catch{} resolve(ok); };
          ws.onopen = () => finish(true);
          ws.onerror = () => finish(false);
          setTimeout(() => finish(false), 2000);
        } catch {
          resolve(false);
        }
      }).then(ok => { setDot(chipWS, ok ? "ok" : "bad"); });
    }

    // Fullscreen (honor site requests + let user press F11 on this shell)
    document.addEventListener("keydown", (e) => {
      if (e.key === "F11") {
        e.preventDefault();
        const el = document.fullscreenElement ? document : view;
        (document.fullscreenElement ? document.exitFullscreen() : view.requestFullscreen()).catch(()=>{});
      }
    });

    // Boot
    (async () => {
      configureUV();

      // Install SW first; if it registers we consider "transport" OK for HTTP path.
      const swOk = await installSW();
      await Promise.all([probeHTTP(), probeWS()]);

      chipTransportText.textContent = swOk ? "transport: ready" : "transport: degraded";
      setDot(chipTransport, swOk ? "ok" : "bad");

      // Optional: focus the address bar
      addr.focus();
    })();
  </script>
</body>
</html>
